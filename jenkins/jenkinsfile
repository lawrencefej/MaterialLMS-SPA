def version

pipeline {
    agent any
    stages {
        stage('initialize_variables') {
          // environment {
          //   // commit = "${ env.GIT_COMMIT }"
          //   // // tag = sh(script: 'git tag --points-at=HEAD', returnStdout: true)?.trim()
          //   // tag = getTag()
          //   // tag2 = sh(script: "git describe --tags ${commit}", returnStdout: true)?.trim()
          //   version = getVersion()
          // }
          steps {
            script {
              // if (env.tag) {
              //   echo 'setting version as tag'
              //   version = tag
              //         } else {
              //   echo 'setting version as commit'
              //   version = commit
              // }
              // echo "commit = ${commit}"
              version = getVersion()
              echo "version = ${version}"
            //   echo "tag = ${tag}"
            // echo "tag2 = ${tag2}"
            }
          }
        }
        stage('Clone the repo') {
      steps {
        // echo 'clone the repo'
        // sh 'rm -fr MaterialLMS-SPA'
        // sh 'git clone https://github.com/lawrencefej/MaterialLMS-SPA.git'
        // sh 'cd MaterialLMS-SPA'
        sh 'ls -alh'
        // testfunc()
        echo "commit = ${env.GIT_COMMIT}"
        echo "version = ${version}"
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        echo "commit take 7 = ${env.GIT_COMMIT.take(7)}"
      }
        }
    }
}

String getVersion() {
  tag1 = sh(script: 'git tag --points-at=HEAD', returnStdout: true)?.trim()
  desc = sh(script: "git describe --tags ${env.GIT_COMMIT}", returnStdout: true)?.trim()
  echo "tag1 = ${env.tag1}"
  echo "desc = ${env.desc}"

  if (tag1 != null) {
    echo 'returning tag'
    return tag1
  }

  echo 'returning commit shas'
  echo "commit in the func = ${env.GIT_COMMIT}"
  commit = "${ env.GIT_COMMIT }"
  return commit
}
